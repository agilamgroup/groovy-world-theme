{% assign retailers = shop.metaobjects['retailer'].values %}

<section style="max-width:1100px;margin:0 auto;padding:24px;">
  <h1>Find Groovy in Stores</h1>
  <p>Search by city or filter by province.</p>

  <div style="display:grid;gap:12px;grid-template-columns:1fr 200px 200px;align-items:end;">
    <input id="search" type="search" placeholder="Search..." style="padding:8px;border:1px solid #ccc;border-radius:6px;" />
    <select id="province"><option value="">All Provinces</option></select>
    <select id="city"><option value="">All Cities</option></select>
  </div>

  <div id="count" style="margin:12px 0;">0 stores found</div>
  <div id="list" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;"></div>
</section>

<script>
(function(){
  const data = [
    {% for r in retailers %}
    {
      name: {{ r.name | json }},
      address1: {{ r.address1 | json }},
      city: {{ r.city | json }},
      province: {{ r.province | json }},
      country: {{ r.country | json }},
      postal: {{ r.postal_code | json }},
      website: {{ r.website | json }},
      phone: {{ r.phone | json }},
      photo: {{ r.photo | image_url: width: 1200 | json }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  const searchInput = document.getElementById('search');
  const provinceSelect = document.getElementById('province');
  const citySelect = document.getElementById('city');
  const list = document.getElementById('list');
  const count = document.getElementById('count');

  const uniq = arr => [...new Set(arr.filter(Boolean))].sort();
  const provinces = uniq(data.map(d => d.province));
  provinces.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p;
    opt.textContent = p;
    provinceSelect.appendChild(opt);
  });

  function fillCities(){
    const p = provinceSelect.value;
    const cities = uniq(data.filter(d => !p || d.province === p).map(d => d.city));
    citySelect.innerHTML = '<option value=\"\">All Cities</option>';
    cities.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      citySelect.appendChild(opt);
    });
  }
  fillCities();

  function render(){
    const q = searchInput.value.toLowerCase();
    const p = provinceSelect.value;
    const c = citySelect.value;
    const filtered = data.filter(d => {
      return (!q || d.name.toLowerCase().includes(q) || d.city.toLowerCase().includes(q))
        && (!p || d.province === p)
        && (!c || d.city === c);
    });

    count.textContent = `${filtered.length} stores found`;
    list.innerHTML = filtered.map(d => {
      const addr = `${d.address1}, ${d.city}, ${d.province}, ${d.postal}, ${d.country}`;
      return `<div style="border:1px solid #ddd; border-radius:8px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); transition:transform 0.2s; background:#fff;">
  ${d.photo ? `<img src="${d.photo}" alt="${d.name}" style="width:100%; height:280px; object-fit:cover; border-radius:8px; margin-bottom:10px;">` : ''}
  <h3>${d.name}</h3>
  <p>${addr}</p>
  ${d.phone ? `<p>Phone: ${d.phone}</p>` : ''}
  ${d.website ? `<a href="${d.website}" target="_blank" style="color:#ff6600; text-decoration:none;">Website</a>` : ''}
</div>`;
    }).join('');
  }

  searchInput.addEventListener('input', render);
  provinceSelect.addEventListener('change', () => { fillCities(); render(); });
  citySelect.addEventListener('change', render);

  render();
})();
</script>
{% schema %}
{
  "name": "Retailer list",
  "settings": []
}
{% endschema %}
