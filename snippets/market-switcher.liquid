{% comment %} Market switcher: CA <-> US {% endcomment %}
<localization-form>
  {%- form 'localization', class: 'market-switcher' -%}
    <input type="hidden" name="locale_code" value="{{ request.locale.iso_code }}">
    <input type="hidden" name="country_code" value="{{ localization.country.iso_code }}">
    <input type="hidden" name="return_to" value="{{ request.path }}{% if request.query_string != blank %}?{{ request.query_string }}{% endif %}">

    {%- assign current_iso = localization.country.iso_code -%}
    <nav class="market-switcher__links" aria-label="Select country or region">
      <a href="#" class="market-switcher__link{% if current_iso == 'CA' %} is-active{% else %} is-inactive{% endif %}" data-code="CA">CA</a>
      <span class="market-switcher__sep">|</span>
      <a href="#" class="market-switcher__link{% if current_iso == 'US' %} is-active{% else %} is-inactive{% endif %}" data-code="US">US</a>
    </nav>
  {%- endform -%}
</localization-form>

<style>
  .market-switcher { display:inline-flex; align-items:center; }
  .market-switcher__links { display:inline-flex; align-items:center; gap:.5rem; font: inherit; }
  .market-switcher__link { color: inherit; text-decoration: underline; }
  .market-switcher__link.is-active { text-decoration: none; font-weight: 600; }
  .market-switcher__sep { opacity:.6; }
  @media (max-width: 989px) { .market-switcher { width: 100%; justify-content: flex-end; } }
</style>

<script>
  (function() {
    var forms = document.querySelectorAll('form.market-switcher');
    if (!forms || !forms.length) return;
    forms.forEach(function(form){
      var ret = form.querySelector('input[name="return_to"]');
      var code = form.querySelector('input[name="country_code"]');
      function setReturnTo() {
        try { if (ret) ret.value = window.location.pathname + window.location.search + window.location.hash; } catch(e) {}
      }
      function submitWith(country) {
        if (!code) return;
        code.value = country;
        setReturnTo();
        form.submit();
      }
      var links = form.querySelectorAll('.market-switcher__link');
      links.forEach(function(a){
        a.addEventListener('click', function(e){
          e.preventDefault();
          var c = a.getAttribute('data-code');
          if (c) submitWith(c);
        });
      });
      document.addEventListener('visibilitychange', function(){ if (!document.hidden) setReturnTo(); });
    });
  })();
</script>


